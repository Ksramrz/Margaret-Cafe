// Startup script to ensure everything is working
// This runs when the application starts

const { PrismaClient } = require('@prisma/client');

const prisma = new PrismaClient();

async function startupCheck() {
  try {
    console.log('üîç Running startup checks...');
    
    // Check database connection
    await prisma.$connect();
    console.log('‚úÖ Database connection successful');
    
    // Check if password column exists
    const columns = await prisma.$queryRaw`
      SELECT column_name 
      FROM information_schema.columns 
      WHERE table_name = 'User' AND column_name = 'password'
    `;
    
    if (columns.length === 0) {
      console.log('‚ö†Ô∏è  Password column missing - adding it now...');
      await prisma.$executeRaw`ALTER TABLE "User" ADD COLUMN "password" TEXT;`;
      console.log('‚úÖ Password column added');
    }

    // Check if coin system columns exist
    const coinColumns = await prisma.$queryRaw`
      SELECT column_name 
      FROM information_schema.columns 
      WHERE table_name = 'User' AND column_name = 'totalCoins'
    `;

    if (coinColumns.length === 0) {
      console.log('‚ö†Ô∏è  Coin system columns missing - adding them now...');
      await prisma.$executeRaw`
        ALTER TABLE "User" 
        ADD COLUMN IF NOT EXISTS "totalCoins" INTEGER DEFAULT 0,
        ADD COLUMN IF NOT EXISTS "currentStreak" INTEGER DEFAULT 0,
        ADD COLUMN IF NOT EXISTS "longestStreak" INTEGER DEFAULT 0,
        ADD COLUMN IF NOT EXISTS "lastLoginReward" TIMESTAMP,
        ADD COLUMN IF NOT EXISTS "level" INTEGER DEFAULT 1,
        ADD COLUMN IF NOT EXISTS "totalPoints" INTEGER DEFAULT 0;
      `;
      console.log('‚úÖ Coin system columns added');
    } else {
      console.log('‚úÖ Coin system columns exist');
    }
    
    console.log('‚úÖ Database schema is correct');
    
    // Check admin user
    const adminUser = await prisma.user.findFirst({
      where: { role: 'ADMIN' }
    });
    
    if (adminUser) {
      console.log('‚úÖ Admin user exists:', adminUser.email);
    } else {
      console.log('‚ö†Ô∏è  No admin user found');
    }
    
    console.log('üöÄ Startup checks completed successfully!');
    
  } catch (error) {
    console.error('‚ùå Startup check failed:', error);
    // Don't throw error to prevent app crash
  } finally {
    await prisma.$disconnect();
  }
}

// Run startup check
startupCheck();

module.exports = { startupCheck };
